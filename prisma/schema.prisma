generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Client {
  id        String   @id @default(cuid())
  nama      String
  npwp      String
  jenisWP   String // "Orang Pribadi" | "Badan"
  email     String
  telepon   String
  alamat    String
  status    String // "Aktif" | "Tidak Aktif"
  createdAt DateTime @default(now())

  deadlines TaxDeadline[]
  documents Document[]
  invoices  Invoice[]
  permits   PermitCase[]

  @@map("clients")
}

model TaxDeadline {
  id           String   @id @default(cuid())
  jenisPajak   String
  deskripsi    String
  tanggalBatas DateTime
  masaPajak    String
  status       String // "Sudah Lapor" | "Belum Lapor" | "Terlambat"
  
  clientId     String
  client       Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientName   String? // Store redundantly for fast queries or relations

  @@map("tax_deadlines")
}

model Document {
  id            String   @id @default(cuid())
  nama          String
  kategori      String // "Faktur Pajak" | "Bukti Potong" | "SPT" | "Laporan Keuangan" | "Lainnya"
  ukuran        String
  tanggalUpload DateTime @default(now())
  catatan       String?
  fileUrl       String?

  clientId      String
  client        Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientName    String

  @@map("documents")
}

model Invoice {
  id           String   @id @default(cuid())
  nomorInvoice String   @unique
  tanggal      DateTime @default(now())
  jatuhTempo   DateTime
  subtotal     Float
  ppn          Float
  total        Float
  status       String // "Draft" | "Terkirim" | "Lunas" | "Jatuh Tempo"
  catatan      String?

  clientId     String
  client       Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientName   String

  items        InvoiceItem[]

  @@map("invoices")
}

model InvoiceItem {
  id          String  @id @default(cuid())
  deskripsi   String
  qty         Int
  harga       Float
  jumlah      Float

  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_items")
}

// ─── PERMIT SYSTEM (Scalable) ────────────────────────────────────────────────

// Config: defines available permit types and their templates
model PermitType {
  id             String   @id @default(cuid())
  slug           String   @unique  // "business", "building", "kitas"
  name           String             // "Perijinan Usaha"
  caseIdPrefix   String             // "NIB", "PBG", "KITAS"
  description    String?
  icon           String?            // lucide icon name e.g. "Briefcase"

  requiredDocs   PermitTypeDocument[]
  checklistItems PermitTypeChecklist[]
  cases          PermitCase[]

  @@map("permit_types")
}

// Config: required documents template per permit type
model PermitTypeDocument {
  id           String     @id @default(cuid())
  permitTypeId String
  permitType   PermitType @relation(fields: [permitTypeId], references: [id], onDelete: Cascade)
  docType      String     // "KTP Direktur"
  isRequired   Boolean    @default(true)
  sortOrder    Int        @default(0)

  @@map("permit_type_documents")
}

// Config: checklist/signature template per permit type
model PermitTypeChecklist {
  id           String     @id @default(cuid())
  permitTypeId String
  permitType   PermitType @relation(fields: [permitTypeId], references: [id], onDelete: Cascade)
  label        String     // "Saya menyetujui syarat & ketentuan OSS"
  description  String?
  sortOrder    Int        @default(0)

  @@map("permit_type_checklists")
}

// Sequential counter for auto-generated case IDs
model PermitCounter {
  id      String @id  // format: "NIB-2026-02"
  counter Int    @default(0)

  @@map("permit_counters")
}

// Data: individual permit case
model PermitCase {
  id           String   @id @default(cuid())
  caseId       String   @unique    // auto-generated: "NIB-2026-02-0001"

  permitTypeId String
  permitType   PermitType @relation(fields: [permitTypeId], references: [id])

  clientId     String
  client       Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientName   String
  advisorId    String?
  serviceType  String              // specific service within the type
  riskCategory String
  status       String              // "Draft" | "Waiting Document" | etc.
  progress     Int
  feeAmount    Float
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  documents    PermitDocument[]
  checklists   PermitChecklist[]

  @@map("permit_cases")
}

// Data: documents for a specific permit case
model PermitDocument {
  id                 String     @id @default(cuid())
  caseId             String
  permitCase         PermitCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  docType            String
  fileUrl            String?
  verificationStatus String     // "Pending" | "Approved" | "Rejected"
  comments           String?
  sortOrder          Int        @default(0)

  @@map("permit_documents")
}

// Data: checklist/signature items for a specific permit case
model PermitChecklist {
  id          String     @id @default(cuid())
  caseId      String
  permitCase  PermitCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  label       String
  description String?
  isChecked   Boolean    @default(false)
  checkedAt   DateTime?
  checkedBy   String?    // userId who checked
  sortOrder   Int        @default(0)

  @@map("permit_checklists")
}
